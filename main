#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Claudeé…ç½®æ–‡ä»¶ç®¡ç†å™¨
æ”¯æŒå¤šé…ç½®ç®¡ç†ã€ä¸€é”®åˆ‡æ¢ã€å‘½ä»¤è¡Œç•Œé¢
"""

import os
import json
import shutil
from pathlib import Path
import tempfile
from datetime import datetime
from typing import Dict, List, Optional
import sys


class ClaudeConfigManager:
    def __init__(self):
        # é…ç½®æ–‡ä»¶è·¯å¾„
        self.claude_dir = Path.home() / ".claude"
        self.settings_file = self.claude_dir / "settings.json"
        self.config_storage = Path(__file__).parent / "claude_configs.json"

        # é…ç½®æ•°æ®
        self.configs = {}
        self.current_config_name = None

        # åˆå§‹åŒ–
        self.init_directories()
        self.load_configs()
        self.detect_current_config()
        
    def init_directories(self):
        """åˆå§‹åŒ–å¿…è¦çš„ç›®å½•"""
        try:
            self.claude_dir.mkdir(exist_ok=True)
            if not self.settings_file.exists():
                # åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶
                default_config = {
                    "api_key": "",
                    "model": "claude-3-sonnet-20240229",
                    "max_tokens": 4096
                }
                with open(self.settings_file, 'w', encoding='utf-8') as f:
                    json.dump(default_config, f, indent=2, ensure_ascii=False)
        except Exception as e:
            print(f"âŒ åˆå§‹åŒ–ç›®å½•å¤±è´¥: {str(e)}")
            sys.exit(1)

    def load_configs(self):
        """åŠ è½½ä¿å­˜çš„é…ç½®"""
        try:
            if self.config_storage.exists():
                with open(self.config_storage, 'r', encoding='utf-8') as f:
                    self.configs = json.load(f)
            else:
                self.configs = {}

            # å¦‚æœæ²¡æœ‰é…ç½®ï¼Œä»å½“å‰settings.jsonåˆ›å»ºé»˜è®¤é…ç½®
            if not self.configs and self.settings_file.exists():
                with open(self.settings_file, 'r', encoding='utf-8') as f:
                    current_config = json.load(f)
                self.configs["é»˜è®¤é…ç½®"] = current_config
                self.save_configs()

        except Exception as e:
            print(f"âŒ åŠ è½½é…ç½®å¤±è´¥: {str(e)}")
            self.configs = {}

    def save_configs(self):
        """ä¿å­˜é…ç½®åˆ°æœ¬åœ°æ–‡ä»¶"""
        try:
            with open(self.config_storage, 'w', encoding='utf-8') as f:
                json.dump(self.configs, f, indent=2, ensure_ascii=False)
        except Exception as e:
            print(f"âŒ ä¿å­˜é…ç½®å¤±è´¥: {str(e)}")

    def refresh_configs(self):
        """åˆ·æ–°é…ç½®æ•°æ®ï¼Œé‡æ–°ä»æ–‡ä»¶åŠ è½½æœ€æ–°é…ç½®"""
        try:
            if self.config_storage.exists():
                with open(self.config_storage, 'r', encoding='utf-8') as f:
                    self.configs = json.load(f)
                print("ğŸ”„ å·²åŠ è½½æœ€æ–°é…ç½®æ•°æ®")
            else:
                self.configs = {}
                print("âš ï¸ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç©ºé…ç½®")
        except Exception as e:
            print(f"âŒ åˆ·æ–°é…ç½®å¤±è´¥: {str(e)}")
            print("ğŸ”„ ä¿æŒä½¿ç”¨å½“å‰é…ç½®æ•°æ®")
    
    def list_configs(self):
        """åˆ—å‡ºæ‰€æœ‰é…ç½®"""
        # æ¯æ¬¡åˆ—å‡ºé…ç½®å‰å…ˆåˆ·æ–°æ•°æ®
        self.refresh_configs()
        
        if not self.configs:
            print("ğŸ“‹ æš‚æ— ä¿å­˜çš„é…ç½®")
            return

        print("\nğŸ“‹ é…ç½®åˆ—è¡¨:")
        print("-" * 50)
        for i, (name, config) in enumerate(self.configs.items(), 1):
            current_marker = " âœ… (å½“å‰ä½¿ç”¨)" if name == self.current_config_name else ""
            print(f"{i}. {name}{current_marker}")
        print("-" * 50)
    
    def detect_current_config(self):
        """æ£€æµ‹å½“å‰ä½¿ç”¨çš„é…ç½®"""
        try:
            if not self.settings_file.exists():
                self.current_config_name = None
                return

            with open(self.settings_file, 'r', encoding='utf-8') as f:
                current_settings = json.load(f)

            # æ¯”è¾ƒå½“å‰é…ç½®ä¸ä¿å­˜çš„é…ç½®
            for name, config in self.configs.items():
                if config == current_settings:
                    self.current_config_name = name
                    return

            self.current_config_name = None

        except Exception as e:
            print(f"âŒ æ£€æµ‹å½“å‰é…ç½®å¤±è´¥: {str(e)}")

    def show_config_content(self, config_name):
        """æ˜¾ç¤ºé…ç½®å†…å®¹"""
        if config_name in self.configs:
            print(f"\nğŸ“„ é…ç½® '{config_name}' çš„å†…å®¹:")
            print("-" * 50)
            config_content = json.dumps(self.configs[config_name], indent=2, ensure_ascii=False)
            print(config_content)
            print("-" * 50)
            if config_name == self.current_config_name:
                print("âœ… è¿™æ˜¯å½“å‰ä½¿ç”¨çš„é…ç½®")
        else:
            print(f"âŒ é…ç½® '{config_name}' ä¸å­˜åœ¨")

    def add_config(self):
        """æ·»åŠ æ–°é…ç½®"""
        print("\nâ• æ·»åŠ æ–°é…ç½®")
        name = input("è¯·è¾“å…¥é…ç½®åç§°: ").strip()
        if not name:
            print("âŒ é…ç½®åç§°ä¸èƒ½ä¸ºç©º")
            return

        if name in self.configs:
            print("âŒ é…ç½®åç§°å·²å­˜åœ¨!")
            return

        # åˆ›å»ºé…ç½®
        self.edit_config_interactive(name, {})

    def edit_config_interactive(self, config_name, config_data):
        """äº¤äº’å¼ç¼–è¾‘é…ç½®"""
        print(f"\nâœï¸ ç¼–è¾‘é…ç½®: {config_name}")
        print("è¯·è¾“å…¥é…ç½®é¡¹ (ç•™ç©ºä½¿ç”¨é»˜è®¤å€¼):")

        # è·å–å½“å‰é…ç½®æˆ–é»˜è®¤å€¼
        api_key = config_data.get("api_key", "")
        model = config_data.get("model", "claude-3-sonnet-20240229")
        max_tokens = config_data.get("max_tokens", 4096)

        # äº¤äº’å¼è¾“å…¥
        new_api_key = input(f"API Key [{api_key}]: ").strip()
        if new_api_key:
            api_key = new_api_key

        new_model = input(f"Model [{model}]: ").strip()
        if new_model:
            model = new_model

        try:
            new_max_tokens = input(f"Max Tokens [{max_tokens}]: ").strip()
            if new_max_tokens:
                max_tokens = int(new_max_tokens)
        except ValueError:
            print("âŒ Max Tokens å¿…é¡»æ˜¯æ•°å­—ï¼Œä½¿ç”¨é»˜è®¤å€¼")

        # ä¿å­˜é…ç½®
        new_config = {
            "api_key": api_key,
            "model": model,
            "max_tokens": max_tokens
        }

        self.configs[config_name] = new_config
        self.save_configs()
        print(f"âœ… é…ç½® '{config_name}' å·²ä¿å­˜")
    
    def edit_config(self):
        """ç¼–è¾‘é…ç½®"""
        # ç¼–è¾‘å‰å…ˆåˆ·æ–°é…ç½®æ•°æ®
        self.refresh_configs()
        
        if not self.configs:
            print("âŒ æš‚æ— é…ç½®å¯ç¼–è¾‘")
            return

        self.list_configs()
        try:
            choice = input("\nè¯·é€‰æ‹©è¦ç¼–è¾‘çš„é…ç½®ç¼–å·: ").strip()
            if not choice.isdigit():
                print("âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—")
                return

            index = int(choice) - 1
            config_names = list(self.configs.keys())

            if 0 <= index < len(config_names):
                config_name = config_names[index]
                self.edit_config_interactive(config_name, self.configs[config_name].copy())
            else:
                print("âŒ æ— æ•ˆçš„é€‰æ‹©")
        except ValueError:
            print("âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—")

    def delete_config(self):
        """åˆ é™¤é…ç½®"""
        # åˆ é™¤å‰å…ˆåˆ·æ–°é…ç½®æ•°æ®
        self.refresh_configs()
        
        if not self.configs:
            print("âŒ æš‚æ— é…ç½®å¯åˆ é™¤")
            return

        if len(self.configs) <= 1:
            print("âŒ è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªé…ç½®!")
            return

        self.list_configs()
        try:
            choice = input("\nè¯·é€‰æ‹©è¦åˆ é™¤çš„é…ç½®ç¼–å·: ").strip()
            if not choice.isdigit():
                print("âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—")
                return

            index = int(choice) - 1
            config_names = list(self.configs.keys())

            if 0 <= index < len(config_names):
                config_name = config_names[index]
                confirm = input(f"ç¡®å®šè¦åˆ é™¤é…ç½® '{config_name}' å—? (y/N): ").strip().lower()
                if confirm in ['y', 'yes']:
                    del self.configs[config_name]
                    self.save_configs()
                    print(f"âœ… é…ç½® '{config_name}' å·²åˆ é™¤")
                    # å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é…ç½®ï¼Œé‡æ–°æ£€æµ‹
                    if config_name == self.current_config_name:
                        self.detect_current_config()
                else:
                    print("âŒ å–æ¶ˆåˆ é™¤")
            else:
                print("âŒ æ— æ•ˆçš„é€‰æ‹©")
        except ValueError:
            print("âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—")
    
    def apply_config(self):
        """åº”ç”¨é…ç½®åˆ°settings.json"""
        # åº”ç”¨å‰å…ˆåˆ·æ–°é…ç½®æ•°æ®
        self.refresh_configs()
        
        if not self.configs:
            print("âŒ æš‚æ— é…ç½®å¯åº”ç”¨")
            return

        self.list_configs()
        try:
            choice = input("\nè¯·é€‰æ‹©è¦åº”ç”¨çš„é…ç½®ç¼–å·: ").strip()
            if not choice.isdigit():
                print("âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—")
                return

            index = int(choice) - 1
            config_names = list(self.configs.keys())

            if 0 <= index < len(config_names):
                config_name = config_names[index]

                confirm = input(f"ç¡®å®šè¦åº”ç”¨é…ç½® '{config_name}' å—? è¿™å°†æ›¿æ¢å½“å‰çš„settings.jsonæ–‡ä»¶ (y/N): ").strip().lower()
                if confirm not in ['y', 'yes']:
                    print("âŒ å–æ¶ˆåº”ç”¨")
                    return

                try:
                    # åˆ›å»ºå¤‡ä»½
                    self.create_backup()

                    # åŸå­æ€§å†™å…¥é…ç½®
                    config_data = self.configs[config_name]
                    temp_file = None

                    try:
                        # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ç¡®ä¿åŸå­æ€§æ“ä½œ
                        with tempfile.NamedTemporaryFile(mode='w', encoding='utf-8',
                                                       dir=self.claude_dir, delete=False) as f:
                            json.dump(config_data, f, indent=2, ensure_ascii=False)
                            temp_file = f.name

                        # åŸå­æ€§æ›¿æ¢
                        shutil.move(temp_file, self.settings_file)
                        temp_file = None

                        self.current_config_name = config_name
                        print(f"âœ… é…ç½® '{config_name}' å·²æˆåŠŸåº”ç”¨åˆ°Claude!")

                    finally:
                        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                        if temp_file and os.path.exists(temp_file):
                            os.unlink(temp_file)

                except Exception as e:
                    print(f"âŒ åº”ç”¨é…ç½®å¤±è´¥: {str(e)}")
            else:
                print("âŒ æ— æ•ˆçš„é€‰æ‹©")
        except ValueError:
            print("âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—")
    
    def create_backup(self):
        """åˆ›å»ºsettings.jsonçš„å¤‡ä»½"""
        if not self.settings_file.exists():
            return

        try:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            backup_file = self.claude_dir / f"settings_backup_{timestamp}.json"
            shutil.copy2(self.settings_file, backup_file)
            print(f"ğŸ“ å·²åˆ›å»ºå¤‡ä»½: {backup_file.name}")

            # åªä¿ç•™æœ€è¿‘10ä¸ªå¤‡ä»½
            backup_files = list(self.claude_dir.glob("settings_backup_*.json"))
            if len(backup_files) > 10:
                backup_files.sort(key=lambda x: x.stat().st_mtime)
                for old_backup in backup_files[:-10]:
                    old_backup.unlink()

        except Exception as e:
            print(f"âŒ åˆ›å»ºå¤‡ä»½å¤±è´¥: {str(e)}")

    def show_menu(self):
        """æ˜¾ç¤ºä¸»èœå•"""
        print("\n" + "="*60)
        print("ğŸ”§ Claudeé…ç½®æ–‡ä»¶ç®¡ç†å™¨")
        print("="*60)
        print("1. åˆ—å‡ºæ‰€æœ‰é…ç½®")
        print("2. æŸ¥çœ‹é…ç½®å†…å®¹")
        print("3. æ·»åŠ æ–°é…ç½®")
        print("4. ç¼–è¾‘é…ç½®")
        print("5. åˆ é™¤é…ç½®")
        print("6. åº”ç”¨é…ç½®")
        print("7. æ˜¾ç¤ºå½“å‰é…ç½®")
        print("0. é€€å‡º")
        print("="*60)

    def show_current_config(self):
        """æ˜¾ç¤ºå½“å‰ä½¿ç”¨çš„é…ç½®"""
        if self.current_config_name:
            print(f"\nâœ… å½“å‰ä½¿ç”¨çš„é…ç½®: {self.current_config_name}")
            self.show_config_content(self.current_config_name)
        else:
            print("\nâ“ å½“å‰é…ç½®æœªåŒ¹é…ä»»ä½•ä¿å­˜çš„é…ç½®")
            if self.settings_file.exists():
                try:
                    with open(self.settings_file, 'r', encoding='utf-8') as f:
                        current_settings = json.load(f)
                    print("å½“å‰ settings.json å†…å®¹:")
                    print("-" * 50)
                    print(json.dumps(current_settings, indent=2, ensure_ascii=False))
                    print("-" * 50)
                except Exception as e:
                    print(f"âŒ è¯»å–å½“å‰é…ç½®å¤±è´¥: {str(e)}")

    def run(self):
        """è¿è¡Œå‘½ä»¤è¡Œç•Œé¢"""
        while True:
            self.show_menu()
            choice = input("\nè¯·é€‰æ‹©æ“ä½œ (0-7): ").strip()

            if choice == "0":
                print("ğŸ‘‹ å†è§!")
                break
            elif choice == "1":
                self.list_configs()
            elif choice == "2":
                # æŸ¥çœ‹é…ç½®å‰å…ˆåˆ·æ–°æ•°æ®
                self.refresh_configs()
                if not self.configs:
                    print("âŒ æš‚æ— é…ç½®")
                    continue
                self.list_configs()
                try:
                    config_choice = input("\nè¯·é€‰æ‹©è¦æŸ¥çœ‹çš„é…ç½®ç¼–å·: ").strip()
                    if config_choice.isdigit():
                        index = int(config_choice) - 1
                        config_names = list(self.configs.keys())
                        if 0 <= index < len(config_names):
                            self.show_config_content(config_names[index])
                        else:
                            print("âŒ æ— æ•ˆçš„é€‰æ‹©")
                    else:
                        print("âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—")
                except ValueError:
                    print("âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—")
            elif choice == "3":
                self.add_config()
            elif choice == "4":
                self.edit_config()
            elif choice == "5":
                self.delete_config()
            elif choice == "6":
                self.apply_config()
            elif choice == "7":
                self.show_current_config()
            else:
                print("âŒ æ— æ•ˆçš„é€‰æ‹©ï¼Œè¯·é‡æ–°è¾“å…¥")

            if choice != "0":
                input("\næŒ‰å›è½¦é”®ç»§ç»­...")
                # é‡æ–°åˆ·æ–°é…ç½®å¹¶æ£€æµ‹å½“å‰é…ç½®
                self.refresh_configs()
                self.detect_current_config()


def main():
    """ä¸»å‡½æ•°"""
    try:
        app = ClaudeConfigManager()
        app.run()
    except KeyboardInterrupt:
        print("\n\nğŸ‘‹ ç”¨æˆ·ä¸­æ–­ï¼Œç¨‹åºé€€å‡º")
    except Exception as e:
        print(f"âŒ åº”ç”¨å¯åŠ¨å¤±è´¥: {str(e)}")
        sys.exit(1)


if __name__ == "__main__":
    main()
